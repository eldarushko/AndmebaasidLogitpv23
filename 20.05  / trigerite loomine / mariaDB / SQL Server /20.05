use UsersData;
create table kasutajad(
id int primary key identity(1,1),
loginn varchar(50),
parool varchar(50));

insert into kasutajad (loginn, parool)
values ('dsdsds0', 'txr4551');
insert into kasutajad (loginn, parool)
values ('dad32', 'dsr4551');
insert into kasutajad (loginn, parool)
values ('dffgdsds0', 't42551');
insert into kasutajad (loginn, parool)
values ('ffggd', '2r4551');
insert into kasutajad (loginn, parool)
values ('qwertds0', 'tkok1');
insert into kasutajad (loginn, parool)
values ('vanop', 'tdad31');
insert into kasutajad (loginn, parool)
values ('dhhk', 't33551');
insert into kasutajad (loginn, parool)
values ('dssvds', '678gs51');
insert into kasutajad (loginn, parool)
values ('vvvcs0', 'tkjhd34');
insert into kasutajad (loginn, parool)
values ('test', 'test');

select * from kasutajad;

create table logi(
    change_id INT IDENTITY PRIMARY KEY,
    id INT NOT NULL,
    loginn VARCHAR(255) NOT NULL, 
    parool varchar(50) NOT NULL,
    updated_at DATETIME NOT NULL,
    operation CHAR(3) NOT NULL,
    CHECK(operation = 'INS' or operation='DEL' or operation='UPD'));

drop table logi;

--1triger
CREATE TRIGGER trg_insert_kasutajad
ON kasutajad
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO logi (id, loginn, parool, updated_at, operation)
    SELECT
        id, loginn, parool, GETDATE(), 'INS'
    FROM inserted;
END;

--2triger
CREATE TRIGGER trg_delete_kasutajad
ON kasutajad
AFTER DELETE
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO logi (id, loginn, parool, updated_at, operation)
    SELECT
        id, loginn, parool, GETDATE(), 'DEL'
    FROM deleted;
END;

--3triger
CREATE TRIGGER trg_update_kasutajad
ON kasutajad
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO logi (id, loginn, parool, updated_at, operation)
    SELECT i.id, i.loginn, i.parool, GETDATE(), 'UPD'
    FROM inserted i
    JOIN deleted d ON i.id = d.id
    WHERE i.loginn <> d.loginn OR i.parool <> d.parool;
END;


UPDATE kasutajad
SET parool = 'test1'
WHERE id = 7; 

DELETE FROM kasutajad
WHERE id = 7;

select * from logi;
select * from kasutajad;


create table Õigused (
	muuda VARCHAR(12),
	kustutada VARCHAR(12),
	Lisa VARCHAR(12),
	ID INT
);
insert into Õigused (muuda, kustutada, Lisa, ID) values ('ei', 'jah', 'ei', 11);
insert into Õigused (muuda, kustutada, Lisa, ID) values ('jah', 'jah', 'ei', 2);
insert into Õigused (muuda, kustutada, Lisa, ID) values ('jah', 'jah', 'ei', 3);
insert into Õigused (muuda, kustutada, Lisa, ID) values ('jah', 'jah', 'ei', 4);
insert into Õigused (muuda, kustutada, Lisa, ID) values ('jah', 'jah', 'ei', 5);
insert into Õigused (muuda, kustutada, Lisa, ID) values ('jah', 'jah', 'ei', 6);
insert into Õigused (muuda, kustutada, Lisa, ID) values ('jah', 'jah', 'ei', 7);
insert into Õigused (muuda, kustutada, Lisa, ID) values ('jah', 'jah', 'ei', 8);
insert into Õigused (muuda, kustutada, Lisa, ID) values ('jah', 'jah', 'ei', 9);
insert into Õigused (muuda, kustutada, Lisa, ID) values ('jah', 'jah', 'ei', 10);

create table logi2(
    change_id INT IDENTITY PRIMARY KEY,
    muuda varchar(12) NOT NULL,
    kustutada VARCHAR(12) NOT NULL, 
    Lisa varchar(12) NOT NULL,
	ID int not null,
    updated_at DATETIME NOT NULL,
    operation CHAR(3) NOT NULL,
    CHECK(operation = 'INS' or operation='DEL' or operation='UPD'));

--1triger

CREATE TRIGGER trg_insert_Õigused
ON Õigused
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO logi2 (muuda, kustutada, Lisa, ID, updated_at, operation)
    SELECT
        muuda,
        kustutada,
        Lisa,
        ID,
        GETDATE(),
        'INS'
    FROM inserted;
END;

--2triger

CREATE TRIGGER trg_delete_Õigused
ON Õigused
AFTER DELETE
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO logi2 (muuda, kustutada, Lisa, ID, updated_at, operation)
    SELECT
        muuda,
        kustutada,
        Lisa,
        ID,
        GETDATE(),
        'DEL'
    FROM deleted;
END;

--3triger

CREATE TRIGGER trg_update_Õigused
ON Õigused
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO logi2 (muuda, kustutada, Lisa, ID, updated_at, operation)
    SELECT
        i.muuda, i.kustutada, i.Lisa, i.ID, GETDATE(), 'UPD'
    FROM inserted i
    JOIN deleted d ON i.ID = d.ID
    WHERE i.muuda <> d.muuda OR i.kustutada <> d.kustutada OR i.Lisa <> d.Lisa;
END;

select * from logi2;

INSERT INTO Õigused (muuda, kustutada, Lisa, ID)
VALUES ('ei', 'ei', 'jah', 100);

UPDATE Õigused
SET kustutada = 'ei'
WHERE ID = 7;


DELETE FROM Õigused
WHERE ID = 100;

select * from logi2;
select * from logi;
-- создать пользователя student и паролем 12345, который не сможет видеть таблицы и не сможет создавать новые таблицы (CREATE TABLE)
DENY CREATE TABLE TO student;
DENY SELECT to student;
